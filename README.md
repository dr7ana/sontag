```text
███████╗ ██████╗ ███╗   ██╗████████╗ █████╗  ██████╗
██╔════╝██╔═══██╗████╗  ██║╚══██╔══╝██╔══██╗██╔════╝
███████╗██║   ██║██╔██╗ ██║   ██║   ███████║██║  ███╗
╚════██║██║   ██║██║╚██╗██║   ██║   ██╔══██║██║   ██║
███████║╚██████╔╝██║ ╚████║   ██║   ██║  ██║╚██████╔╝
╚══════╝ ╚═════╝ ╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝
```

the C++ interpreter against simply interpreting

## Requirements

- Linux
- CMake
- Ninja
- Latest stable LLVM toolchain (>= 20), including:
  - `clang++` (C++23 compiler; available in `PATH` or set via `--clang`)
  - `llvm-mca` (for `:mca`)
  - `llvm-objdump`
- `nm` (binutils) for symbol discovery

## Build

```bash
mkdir -p build
cd build
cmake ..
ninja -v
```

### Binary output:

```bash
./build/sontag
```

### Running tests

```bash
./build/tests/alltests
```

## Quickstart

```text
:decl int value = 64;
:decl int values[2];
values[0] = value * value;
values[1] = value * 2;
:show all
:symbols
:set opt=O0
:dump
:asm
:ir
:mca
```

### Output

```bash
sontag > :decl int value = 64;
stored decl #1 (state: valid)
sontag > :decl int values[2];
stored decl #2 (state: valid)
sontag > values[0] = value * value;
stored cell #1 (state: valid)
sontag > values[1] = value * 2;
stored cell #2 (state: valid)
sontag > :show all
// generated by sontag m1
// decl cell 1
int value = 64;

// decl cell 2
int values[2];

int __sontag_main() {
    // exec cell 1
    values[0] = value * value;

    // exec cell 2
    values[1] = value * 2;

    return 0;
}
sontag >
```

## Current Functionality

- interactive C++ cell entry in a REPL loop
- top-level declaration cells (`:decl`) and executable cells
- generated translation unit preview (`:show all`)
- symbol listing from compiled output (`:symbols`)
- assembly output (`:asm`)
- object disassembly via `llvm-objdump` (`:dump`)
- LLVM IR output (`:ir`)
- compiler diagnostics output (`:diag`)
- microarchitecture analysis via `llvm-mca` (`:mca`)
- graph generation (`:graph <subcommand>`)
  - control-flow graphs (`:graph cfg`)
  - function call graphs (`:graph call`)
  - def-use graphs (`:graph defuse`)
- structured visualization data export (`:inspect <subcommand>`)
  - source/IR/asm line-map data (`:inspect asm`)
  - mca summary/heatmap data (`:inspect mca`)

## How Input Works

- `:decl <code>` stores top-level declarations (includes, globals, functions).
- non-command input stores executable cells in synthesized `__sontag_main()`.
- press `Shift+Tab` (or `Ctrl+Enter`) to insert a newline while composing a multi-line cell.
- use `:show all` to inspect the full generated source in order: declarations first, then executable cells wrapped in the synthesized function.

## Snapshots and `@last` tag

- a snapshot is a persisted point-in-time code state (all current `:decl` cells + executable cells) identified by cell count.
- `:mark <name>` records a named snapshot marker at the current state.
- `:snapshots` lists recorded markers in the session.
- `@last` in analysis commands means analyze the latest/current snapshot state; passed by default

## Analysis Functionalities

- `:symbols` compiles the current snapshot to an object file, runs symbol discovery, and prints symbol kind/name entries.
- `:asm [symbol|@last]` compiles the current snapshot to assembly and prints full assembly text or a symbol-scoped assembly block.
- `:dump [symbol|@last]` compiles the current snapshot to an object file, disassembles it, and prints instruction-level object disassembly.
- `:ir [symbol|@last]` compiles the current snapshot with LLVM IR emission and prints full IR text or a symbol-scoped IR definition.
- `:diag [symbol|@last]` runs compile diagnostics on the current snapshot and prints compiler errors/warnings (optionally filtered by symbol).
- `:mca [symbol|@last]` compiles to assembly, runs microarchitecture analysis, and prints throughput/latency/resource-pressure analysis text.
- `:mca` does not operate on data symbols (for example `[D]`/`[B]` entries from `:symbols`).
- `:inspect asm [symbol|@last]` emits structured JSON containing aligned source/IR/asm line records for downstream tooling.
- `:inspect mca [summary|heatmap] [symbol|@last]` emits structured JSON from `llvm-mca` output and prints a compact terminal summary.
- `:graph cfg [symbol|@last]` compiles to LLVM IR, builds a function-scoped control-flow graph, and emits graph summary + DOT artifact (with optional rendered image).
- `:graph call [symbol|@last]` compiles to LLVM IR, builds a root-scoped function call graph, and emits graph summary + DOT artifact (with optional rendered image).
- `:graph defuse [symbol|@last]` compiles to LLVM IR, builds a function-scoped def-use graph, and emits graph summary + DOT artifact (with optional rendered image).

## `:graph`

Use `:graph <subcommand>` for graph-oriented analysis outputs.

Supported subcommands:
- `cfg`: function-scoped control-flow graph.
- `call`: root-scoped function call graph.
- Add new `:graph` subcommands to this list as they are implemented.

Examples:

```text
:graph cfg
:graph cfg __sontag_main
:graph call
:graph call __sontag_main
```

Output includes:
- `cfg`:
  - `function`: resolved function used to build the CFG
  - `blocks`: number of CFG blocks
  - `edges`: number of CFG edges
  - `dot`: path to the DOT artifact in `artifacts/graphs/cfg`
  - `rendered`: rendered graph path (or `<none>` if rendering is unavailable)
- `call`:
  - `root`: resolved root function used to build the call graph
  - `nodes`: number of graph nodes
  - `edges`: number of call edges
  - `dot`: path to the DOT artifact in `artifacts/graphs/call`
  - `rendered`: rendered graph path (or `<none>` if rendering is unavailable)

## `:inspect`

Use `:inspect <subcommand>` for structured visualization data payloads.

Supported subcommands:
- `asm`: source/IR/asm alignment payload (JSON).
- `mca summary`: parsed llvm-mca summary payload (JSON).
- `mca heatmap`: parsed llvm-mca resource-pressure payload (JSON).

Examples:

```text
:inspect asm
:inspect asm __sontag_main
:inspect mca
:inspect mca summary
:inspect mca heatmap __sontag_main
```

Notes:
- `:inspect` commands emit JSON artifacts under `artifacts/inspect/...` and print a compact terminal summary.
- `:inspect` commands do not generate rendered image files.
